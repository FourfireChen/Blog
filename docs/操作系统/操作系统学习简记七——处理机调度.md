# 操作系统学习简记七——处理机调度

## 概念

### 处理机调度

* 
从就绪队列中挑选下一个占用CPU运行的进程；
* 
从多个可用CPU中挑选就绪进程可以使用的CPU资源。

### 调度程序

挑选进程和CPU的内核函数，内容包括：

* 调度策略
* 调度时机

### 调度时机

#### 运行调度程序的条件

状态发生变化时

##### 非抢占系统

当前进程主动放弃

* 有进程从运行切换到等待；
* 有进程退出

##### 可抢占系统

* 中断服务程序响应完成
* 当前进程被抢占，有两种情况

  * 时间片用完
  * 进程从等待切换到就绪

## 调度策略

如何从就绪队列中选择下一个执行进程

### 考核指标

如何判断一个调度算法好坏？

通常情况下进程在CPU计算和IO操作之间交替，基于此，衡量标准有几种：

* CPU使用率：CPU处于忙时间百分比；
* 吞吐量：单位时间内完成的进程数量；
* 周转时间：进程从初始化到结束的总时间；
* 等待时间：进程在就绪队列中的总时间；
* 响应时间：从提交请求到产生响应花费的时间；

### 目标

* 响应：

  * 响应时间低，低延迟；
  * 响应时间稳定，不抖动；
* 吞吐量：增加吞吐量

  * 减少开销（操作系统开销，上下文切换）；
  * 系统资源的更高效利用；
  * 减少等待时间；
* 公平性

### 调度算法

#### FCFS(First Come, First Serve)

上一个进程主动让出CPU时，按照进程进入就绪状态的顺序，选出下一个进程。

该算法周转时间和排列顺序有关，短进程排前面，平均周转时间短。

* 缺点：

  * 平均等待时间波动大；
  * IO资源利用率低；

#### 短进程优先

##### 短进程优先算法（SPN）

对FCFS的优化，选择预期执行时间最短的进程，但这个预期时间只是估计值。

* 
短剩余时间优先

如果目前进程执行时间比新进来的时间长，抢占
* 
  缺点

  * 短进程太多会使长进程总是得不到资源
  * 预知未来

    * 用户进程指定；
    * 已历史时间预测未来；

#### 高响应比优先

等待时间+执行时间/执行时间，这个值越大，执行优先级越高。

#### 时间片轮转（RR）

* 时间片：处理机资源分配的基本时间单位；
* 思路：时间片结束后，按FCFS选择下一个；
* 开销：

  * 比较频繁的上下文切换
* 时间片大小：通常选择维持上下文切换开销处于百分之一左右；

#### 多级反馈队列（MQ）

* 
  多级队列

  就绪队列分为多个独立子队列。

  * 思路：

    * 队列内部分别独立调度策略，如前台队列RR，后台FCFS
    * 队列间调度

      * 固定时间片
* 
  多级反馈队列：对多级队列的改进

进程可在不同队列之间移动

#### 公平共享调度（FSS）

以用户为单位，做优先级分配。

## 实时操作系统

### 定义

正确性依赖于时间和功能两方面的操作系统，也即需要在一定的时间内完成某些任务，才算正确。

这种操作系统的衡量指标是对时间的约束性。

### 实时任务

#### 定义

一次计算、文件读取等等。

#### 属性

* 需要的资源
* 定时的参数：请求时间、截止时间

#### 周期实时任务

有规律性的重复，于是会有周期的概念。

#### 硬时限

错过任务时限会有严重后果，操作系统必须提前验证能不能完成。

#### 软时限

如果不能满足，可以降低要求。

#### 可调度性

可以保证多任务下，所有任务都满足其时限。

#### 算法

##### 速率单调调度算法

周期越短优先级越高

##### 最早截止时间优先

截至时间越早优先级越高

## 多处理器调度

### 目的

实现负载共享，尽可能多利用资源。

### 对称多处理器调度

* 
每个处理器可以有自己的调度算法
* 
访问共享资源时需要同步

#### 进程分配

##### 静态

进程在开始时被分配一个处理器，之后就固定由其执行。每个处理机都有自己的就绪队列。可能导致负载不均。

##### 动态

* 进程可分配到任意空闲处理机
* 所有处理机共享一个就绪队列，则需要同步
* 调度开销较大
* 负载均衡

## 优先级反置

### 定义

高优先级长时间等待低优先级所占用的资源。

如，高优先级P1等待低优先级P2的资源，此时有另外的进程优先级高于P2在长时间运行。

### 做法

#### 优先级继承

占用资源的低优先级进程继承需要资源的高优先级的优先级

#### 优先级天花板

占用资源进程的优先级提高到所有可能申请该资源的进程的最高级相同
