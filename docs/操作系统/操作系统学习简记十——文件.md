# 操作系统学习简记十——文件

## 定义

* 文件系统：操作系统用来管理持久性数据的子系统，提供存储和访问功能。
* 文件：文件系统的基本单位。由文件名标识。存储时分文件头和文件内容，文件头会存储本文件的属性，如大小、位置、命名等等。

## 文件系统功能

* 分配文件磁盘空间

  * 管理文件块
  * 管理空闲空间
  * 分配
* 管理文件集合：抽象化

  * 定位
  * 命名
  * 文件系统结构：组织方式
* 数据的可靠和安全

## 文件描述符

### 定义

指打开的文件在内存中存储的相应信息，存储在内核的打开文件表中。**一个进程一个打开文件表**

### 内容

* 
文件指针：最近一次读写位置。
* 
文件打开计数：最后一个进程关闭时，要把文件关闭
* 文件的磁盘位置
* 访问权限

### 文件的用户视图

* 持久的数据结构

### 文件的系统视图

字节序列的集合，操作系统并不关心数据结构，只当其是数据块的集合。

> 数据块是逻辑的存储单元
>
> 扇区是物理存储单元

### 用户视图和系统视图的转换

* 读文件：获取字节所在的数据块，必须以块为单位，返回需要的内容。
* 写文件：获取数据块，修改对应部分，写回磁盘。

**基本操作单位是数据块，即使只访问一个字节，也必须取出整个数据块**

### 访问模式

* 顺序访问：按字节依次访问
* 随机访问：从中间读写
* 索引访问：按数据特征索引。这个操作系统比较少完全实现，一般通过数据库实现。

### 文件内部结构

* 无结构：字节序列
* 简单记录：分列、固定长度
* 复杂结构：文档、可执行等等

## 文件系统结构

### 分层

以目录的形式组织，目录也是一种特殊的文件。

### 目录实现

* 文件名的线性列表，元素类型是指向文件的指针
* 哈系表

### 文件别名

* 硬链接：多个文件项指向一个文件
* 软链接：以快捷方式指向其他文件

### 文件系统种类

* 磁盘文件系统：存在磁盘上，如FAT、EXT2等等
* 数据库文件系统：可识别文件特征
* 日志文件系统：记录文件系统发生的事件
* 网络/分布式文件系统
* 特殊/虚拟文件系统：如管道等

## 虚拟文件系统

封装统一的文件管理接口，将不同的文件系统，对上层提供相同的抽象。

### 数据结构

* 文件卷控制块：superblock。一个文件系统一个控制块，记录文件系统信息、块大小、空余块等等信息。
* 文件控制块：vnode/inode。每个文件一个，记录文件的详细信息、访问权限、拥有者、大小、位置等等。
* 目录项：dentry。每个目录一个目录项，树状记录。

所以整个文件系统的组织视图为：

文件卷控制块->目录项->文件控制块->数据块

由此组成树。

### 存储结构

卷控制块、文件控制块、目录节点都会持久化存储在外存中，在需要的时候加载如内存。

* 
卷控制块：挂载时加载入内存
* 
文件控制块：访问相应文件时加载
* 目录节点：遍历到的时候加载
