# 2019面试准备——网络

## 七层/五层模型及其设计思想

### OSI七层

Open System Interconnect，开放式系统互联

+ 原则
  + 同一层各个节点结构相同功能相同
  + 相邻层通过接口通讯
  + 上层使用下层的服务
+ 层次
  + 物理层：比特
  + 数据链路层：帧。物理寻址、成帧等。**MAC地址（物理地址）**
  + 网络层：数据包。IP协议、路由协议、子网掩码。帧组成包，封装包头，带有逻辑地址等信息
  + 传输层：TCP->段（Seg）UDP->数据报
  + 会话层：不参与具体传输，负责访问验证和会话管理，如建立会话
  + 表示层：数据格式化、转换、压缩解压、加密解密
  + 应用层：为应用提供服务。http等

### TCP/IP五层

应用层=OSI的5 6 7层

## TCP/UDP：传输层协议

+ TCP

  + 发送和接收都有缓冲区

  + 参数

    + Seq：序列号，整个字节流中每个字节的编号，4字节
      + 计算方法
        + 三次握手：随机的，两方分别随机
        + 传输数据：收到的ACK num
  + 每个数据包长度不一，数据包中的序列号指的是该包中第一个字节的序号
    
    + ACK num：确认号，4字节，32位。ACK标记位为1时才带有
      + 确认的是目前已收到的前面所有数据
      + 非立即发送
        + 顺序问题，等待前面数据到达之后才可发送
        + 定时器每200ms检查是否需要发送
          + 为了合并
          + 尽量把ACK带在数据包里
      + 达到最大值之后会置0
      + 计算方法
        + 握手：收到的Seq+1
        + 传输数据：收到的Seq+收到的size-54(以太网协议头14+IP头20+TCP头20)
    + SYN：Synchronize：建立连接
    + FIN：Finish：关闭连接
    + PSH：推送位。使发送缓冲区立即打包数据发送，接收缓冲区立即打包数据返回给read函数
    
  + 三握

    - 流程
      - C发起：SYN=1 seq=随机x
      - S接收、返回确认：SYN=1 seq=随机y ACK=x+1
      - C再确认：seq=x+1 ACK=y+1
    - 目的：二握好理解，三握是防止S一直等待

  + 四挥

    - 流程：C/S均可主动。

      - C(S)发起(FIN=1 seq=x) -> S(C)确认(ACK=x+1)
      - S(C)发起(FIN=1 seq=y) -> C(S)确认(ACK=y+1)

    - 目的：全双工通讯。

      1. 主->被：我不写了
      2. 被->主：确认
      3. 被->主：我不写了
      4. 主->被：确认

      3和4合并不合适，因为被动方无法预知还有多久才想关闭自己，这会导致主动方等待确认超时，不断重发断开连接的请求

  + 滑动窗口：对每次发送包数量实现最优解

    （https://wizardforcel.gitbooks.io/network-basic/7.html）

    + 发送方：buffer分为：1已确认、2已发送未确认、3待发送、4未发送，2和3一起为发送方窗口
      + 窗口长度为接收方指定给发送方的：TCP头中的window字段
      + 收到确认之后，窗口右滑
      + 发送方要发送的是3
    + 接收方：buffer分为：1已接收、2准备接收、3未准备接收，2和3为接收方窗口
      + 同样道理，取走buffer中的数据之后，窗口右滑

  + 拥塞控制

    + 慢启动：先线性上升，再指数上升，直到上限，进入拥塞避免
    + 拥塞避免：恢复为线性上升
    + 拥塞发生：丢包严重下会重置发送宽度，不严重下有可能是将宽度和上限都降半，然后进入快速恢复
    + 快速恢复：不太清楚
    
  + 多用于文件传输等对数据准确性有要求的

+ UDP

  + 无连接：不需要建立连接
  + 不可靠：不需要维护状态
  + 开销小、简单：首部小
  + 支持多播广播
  + 面向报文（上层）：应用层给UDP多长的报文，就发送多长（面向字节流会对报文长度做划分）
  + 多用于即时通讯、在线视频等等

## 网络层

+ IP协议：无状态不连接不可靠。逻辑地址。提供点到点的服务
+ 子网掩码：子网掩码决定了IP地址如何切割成网络号和主机号。如子网掩码255.255.255.0。前24位为1，后8位为0，则IP的24位为网络号，后8位为主机号

## Http

+ GET/POST
  + 本质上用的都是TCP，GET也可以带body，POST也可以拼接url
  + 某些框架下会将Post实现为两个TCP包，先发header再发data，大多数情况下不会
+ 状态码
  + 100+：继续
  + 200+：成功
  + 300+：重定向
  + 400+：客户端错误。如语法错误
  + 500+：服务器错误。服务器在处理请求的过程中出错
+ https
  + http下加入ssl层
  + 端口一般是443（http80）

## 其他

+ dns：域名->IP
  + 主机 -> 本地域名服务器。如有缓存，直接返回
  + 本地域名服务器 -> 根域名服务器：该去的顶级域名服务器IP
  + 本地域名服务器 -> 顶级域名服务器：该去的权限域名服务器IP
  + 本地域名服务器 -> 权限域名服务器：目标IP
  + 本地域名服务器 -> 主机：目标IP
+ 流媒体
+ 非堆成加密
  + 流程
    + 接收方生成公钥私钥
    + 把公钥发送给发送方
    + 发送方用公钥给数据加密，发送给接收方
    + 接收方用私钥解密
+ 常见对称加密
  + MD5：基于哈希函数。不可逆。产生信息摘要，用于检查完整性
  + SHA1：安全性比MD5强，位数多。不可逆
  + AES：可逆